name: CI/CD Pipeline

on:
  push:
    branches: ["main"]

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Lint & Test (services)
        run: |
          echo "Running basic lint/test steps for Node services"
          # If you have more advanced tests, add them here per-service
          for dir in auth-service task-service board-service; do
            if [ -f "$dir/package.json" ]; then
              echo "=> $dir: npm ci"
              (cd $dir && npm ci)
              if [ -f "$dir/package.json" ] && (jq -r '.scripts.test // empty' $dir/package.json | grep -q .); then
                echo "=> $dir: running tests"
                (cd $dir && npm test || true)
              fi
            fi
          done

      - name: Build Docker images (local)
        run: |
          docker build -t auth-service:latest ./auth-service
          docker build -t task-service:latest ./task-service
          docker build -t board-service:latest ./board-service

      - name: Security Scan with Trivy (filesystem)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          ignore-unfixed: true
          format: "table"
          exit-code: "0"
          severity: "HIGH,CRITICAL"

      - name: Validate Kubernetes manifests (dry-run)
        run: |
          echo "Validating Kubernetes manifests with kubectl client-side dry-run"
          sudo snap install kubectl --classic || true
          kubectl version --client || true
          kubectl apply -f k8s/ --dry-run=client

      - name: Terraform fmt (infra)
        if: always()
        run: |
          if [ -d infra/terraform ]; then
            (cd infra/terraform && terraform -version || true)
          fi

      - name: Pipeline summary
        run: |
          echo "CI pipeline finished. Images built locally in runner. If you want to deploy, configure kubectl context or run Terraform infra scripts locally."
